name: Build Custom Backends

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'backend/python/kokoro/**'
      - 'backend/python/vibevoice/**'
      - 'backend/python/vibevoice-longform/**'
      - 'backend/backend.proto'
  workflow_dispatch:
    inputs:
      backend:
        description: 'Which backend to build'
        required: true
        default: 'all'
        type: choice
        options:
          - kokoro
          - vibevoice
          - vibevoice-longform
          - all

env:
  REGISTRY: ghcr.io

jobs:
  # Detect which backends need to be built based on changed files
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      kokoro: ${{ steps.changes.outputs.kokoro }}
      vibevoice: ${{ steps.changes.outputs.vibevoice }}
      vibevoice_longform: ${{ steps.changes.outputs.vibevoice_longform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          # For workflow_dispatch, check the input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            case "${{ inputs.backend }}" in
              kokoro)
                echo "kokoro=true" >> $GITHUB_OUTPUT
                echo "vibevoice=false" >> $GITHUB_OUTPUT
                echo "vibevoice_longform=false" >> $GITHUB_OUTPUT
                ;;
              vibevoice)
                echo "kokoro=false" >> $GITHUB_OUTPUT
                echo "vibevoice=true" >> $GITHUB_OUTPUT
                echo "vibevoice_longform=false" >> $GITHUB_OUTPUT
                ;;
              vibevoice-longform)
                echo "kokoro=false" >> $GITHUB_OUTPUT
                echo "vibevoice=false" >> $GITHUB_OUTPUT
                echo "vibevoice_longform=true" >> $GITHUB_OUTPUT
                ;;
              all)
                echo "kokoro=true" >> $GITHUB_OUTPUT
                echo "vibevoice=true" >> $GITHUB_OUTPUT
                echo "vibevoice_longform=true" >> $GITHUB_OUTPUT
                ;;
            esac
            exit 0
          fi

          # For push events, check which files changed
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)

          # Check for kokoro changes (only kokoro files or backend.proto)
          if echo "$CHANGED_FILES" | grep -qE '^backend/python/kokoro/|^backend/backend\.proto$'; then
            echo "kokoro=true" >> $GITHUB_OUTPUT
          else
            echo "kokoro=false" >> $GITHUB_OUTPUT
          fi

          # Check for vibevoice (0.5B) changes
          if echo "$CHANGED_FILES" | grep -qE '^backend/python/vibevoice/|^backend/backend\.proto$'; then
            echo "vibevoice=true" >> $GITHUB_OUTPUT
          else
            echo "vibevoice=false" >> $GITHUB_OUTPUT
          fi

          # Check for vibevoice-longform (1.5B) changes
          if echo "$CHANGED_FILES" | grep -qE '^backend/python/vibevoice-longform/|^backend/backend\.proto$'; then
            echo "vibevoice_longform=true" >> $GITHUB_OUTPUT
          else
            echo "vibevoice_longform=false" >> $GITHUB_OUTPUT
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

  build-kokoro:
    needs: detect-changes
    if: needs.detect-changes.outputs.kokoro == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and push Kokoro backend (CUDA 12)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.python
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/localai-backends:latest-gpu-nvidia-cuda-12-kokoro
            ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/localai-backends:cuda12-kokoro
          build-args: |
            BACKEND=kokoro
            BUILD_TYPE=cublas
            CUDA_MAJOR_VERSION=12
            BASE_IMAGE=nvidia/cuda:12.4.0-devel-ubuntu22.04

  build-vibevoice:
    needs: detect-changes
    if: needs.detect-changes.outputs.vibevoice == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and push VibeVoice backend (CUDA 12)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.python
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/localai-backends:latest-gpu-nvidia-cuda-12-vibevoice
            ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/localai-backends:cuda12-vibevoice
          build-args: |
            BACKEND=vibevoice
            BUILD_TYPE=cublas
            CUDA_MAJOR_VERSION=12
            BASE_IMAGE=nvidia/cuda:12.4.0-devel-ubuntu22.04

  build-vibevoice-longform:
    needs: detect-changes
    if: needs.detect-changes.outputs.vibevoice_longform == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and push VibeVoice Longform backend (CUDA 12)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.python
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/localai-backends:latest-gpu-nvidia-cuda-12-vibevoice-longform
            ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/localai-backends:cuda12-vibevoice-longform
          build-args: |
            BACKEND=vibevoice-longform
            BUILD_TYPE=cublas
            CUDA_MAJOR_VERSION=12
            BASE_IMAGE=nvidia/cuda:12.4.0-devel-ubuntu22.04
